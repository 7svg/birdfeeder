<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jamnagar Bird Feeding Community</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1b4332">
    <link rel="apple-touch-icon" href="logoo.png">
    
    <link rel="icon" type="image/png" href="logoo.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --forest-dark: #1b4332; --forest-light: #40916c;
            --accent-leaf: #95d5b2; --text-dark: #081c15;
            --glass-bg: rgba(255, 255, 255, 0.85); --glass-border: rgba(255, 255, 255, 0.4);
            --alert-red: #e74c3c;
        }
        body {
            margin: 0; font-family: 'Nunito', sans-serif;
            background-color: #134e5e; background-image: url('bg.jpg'); background-size: cover;
            background-position: center; background-attachment: fixed;
            color: var(--text-dark); text-align: center; line-height: 1.6;
        }
        header {
            background: rgba(27, 67, 50, 0.9); backdrop-filter: blur(10px); color: white;
            padding: 30px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-bottom: 2px solid var(--accent-leaf); position: relative; 
        }
        
        .lang-toggle {
            position: absolute; top: 32px; right: 80px; background: rgba(255,255,255,0.2);
            border: 2px solid var(--accent-leaf); padding: 5px 12px; border-radius: 20px;
            cursor: pointer; font-weight: bold; color: white; font-family: 'Nunito', sans-serif; 
            transition: all 0.2s ease;
        }
        .lang-toggle:hover { background: rgba(255,255,255,0.4); transform: scale(1.05); }

        .top-right-avatar {
            position: absolute; top: 25px; right: 20px; width: 45px; height: 45px;
            border-radius: 50%; border: 2px solid var(--accent-leaf); object-fit: cover;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; display: none; 
            transition: all 0.2s ease;
        }
        .top-right-avatar:hover { transform: scale(1.1); box-shadow: 0 6px 15px rgba(0,0,0,0.4); }
        
        #timeBanner { padding: 12px; font-weight: bold; font-size: 1.1em; transition: background 0.5s, color 0.5s; }
        .day-banner { background: #f1c40f; color: #8e44ad; }
        .night-banner { background: #2c3e50; color: #ecf0f1; }
        section { padding: 20px; }
        
        .card {
            background: var(--glass-bg); backdrop-filter: blur(12px); margin: 25px auto; padding: 30px;
            width: 90%; max-width: 800px; border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--glass-border); transition: all 0.4s ease; box-sizing: border-box; 
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2); }
        .emergency-card { border: 2px solid var(--alert-red); background: rgba(253, 237, 236, 0.9); }
        .emergency-card h2 { color: var(--alert-red); border-bottom-color: var(--alert-red); }
        h2 { color: var(--forest-dark); border-bottom: 2px dashed var(--accent-leaf); padding-bottom: 10px; display: inline-block; margin-top: 0; }
        #map { height: 400px; border-radius: 15px; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 1; position: relative; }
        #timer {
            font-size: 28px; font-weight: 800; color: white; background: linear-gradient(135deg, var(--forest-light), var(--forest-dark));
            padding: 15px 30px; border-radius: 50px; display: inline-block; margin-top: 15px; box-shadow: 0 4px 15px rgba(27, 67, 50, 0.4); letter-spacing: 2px;
        }
        
        .welcome-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .stats-container { display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; margin-top: 15px; background: rgba(255,255,255,0.5); padding: 15px; border-radius: 15px; border: 1px dashed var(--accent-leaf); }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; text-align: left; }
        .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; border-radius: 12px; background: rgba(255,255,255,0.6); border: 1px solid var(--accent-leaf); font-size: 1.1em; font-weight: bold; }
        .rank-1 { background: linear-gradient(135deg, #ffd700 0%, #fdb931 100%); color: #8a6327; border: none; }
        .rank-2 { background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%); color: #424242; border: none; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #a0522d 100%); color: #fff; border: none; }
        .info-card { text-align: left; }
        .info-card h3 { color: var(--forest-dark); margin-top: 25px; margin-bottom: 10px; font-size: 1.3em; }
        .info-list { list-style-type: none; padding: 0; margin: 0; }
        .info-list li { background: rgba(255, 255, 255, 0.6); margin-bottom: 10px; padding: 12px 18px; border-radius: 12px; border-left: 5px solid var(--forest-light); font-size: 1.05em; transition: transform 0.2s; }
        .info-list li:hover { transform: translateX(5px); }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(8, 28, 21, 0.7); backdrop-filter: blur(6px); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--glass-bg); padding: 40px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--glass-border); box-sizing: border-box; max-height: 90vh; overflow-y: auto; position: relative;
        }
        .modal-content input[type="text"], .modal-content select { width: 80%; padding: 12px 20px; margin: 10px 0 20px 0; box-sizing: border-box; border: 2px solid var(--accent-leaf); border-radius: 50px; font-size: 16px; font-family: 'Nunito', sans-serif; outline: none; background: white; }
        
        .btn { background: linear-gradient(135deg, var(--forest-light), var(--forest-dark)); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; font-family: 'Nunito', sans-serif; transition: all 0.2s ease; }
        .btn:hover { transform: scale(1.05); }
        
        .logout-btn { background: transparent; color: #d9534f; border: 2px solid #d9534f; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; font-family: 'Nunito', sans-serif; cursor: pointer; display: none; transition: all 0.2s ease; }
        .logout-btn:hover { background: #d9534f; color: white; }
        .help-btn { background: transparent; color: #8e44ad; border: 2px solid #8e44ad; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; font-family: 'Nunito', sans-serif; cursor: pointer; display: inline-block; transition: all 0.2s ease; }
        .help-btn:hover { background: #8e44ad; color: white; }
        .install-btn { background: linear-gradient(135deg, #2980b9, #2c3e50); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; font-family: 'Nunito', sans-serif; cursor: pointer; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s ease; }
        .install-btn:hover { transform: scale(1.05); }
        .whatsapp-btn { background: linear-gradient(135deg, #25D366, #128C7E); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; font-family: 'Nunito', sans-serif; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: all 0.2s ease; }
        .whatsapp-btn:hover { transform: scale(1.05); }

        #ai-section { display: none; } 
        .upload-label { display: inline-block; background: white; color: var(--forest-dark); border: 2px dashed var(--forest-light); padding: 15px 30px; border-radius: 15px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 15px; }
        .upload-label:hover { background: #e8f5e9; border-color: var(--forest-dark); }
        #ai-status { margin-top: 15px; font-weight: bold; font-size: 1.1em; }
        .scanning { color: #f39c12; animation: pulse 1s infinite; }
        .success { color: #27ae60; }
        .streak-badge { background: #ffeaa7; color: #d35400; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; display: inline-block; margin-left: 10px;}
        
        footer { background: var(--forest-dark); color: var(--accent-leaf); padding: 20px; margin-top: 40px; font-weight: 600; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- SPOTLIGHT TOUR CSS --- */
        .tour-overlay-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.75); z-index: 10000;
            opacity: 0; visibility: hidden; transition: opacity 0.4s ease;
        }
        .tour-overlay-bg.active { opacity: 1; visibility: visible; }
        
        .highlighted-for-tour {
            position: relative !important; 
            z-index: 10001 !important;
            transform: scale(1.02) !important;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.9) !important;
            border-radius: 20px !important; 
            transition: all 0.4s ease;
        }

        .tour-dialog {
            position: fixed; bottom: -150px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; background: white; border-radius: 20px;
            padding: 20px; z-index: 10002; box-shadow: 0 -10px 40px rgba(0,0,0,0.4);
            display: flex; gap: 15px; align-items: center; border: 3px solid var(--forest-dark);
            transition: bottom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .tour-dialog.active { bottom: 25px; }

        .tour-character {
            font-size: 45px; background: #e8f5e9; width: 75px; height: 75px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; border: 3px solid var(--forest-light); flex-shrink: 0;
            animation: bounce 2s infinite; box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        .tour-content { text-align: left; flex-grow: 1; width: 100%; }
        .tour-content h3 { margin: 0 0 5px 0; color: var(--forest-dark); font-size: 1.1em;}
        .tour-content p { margin: 0 0 12px 0; font-size: 0.95em; color: #444; line-height: 1.4; }
        
        .tour-btn {
            background: var(--forest-light); color: white; border: none; padding: 8px 18px;
            border-radius: 20px; font-weight: bold; font-family: 'Nunito', sans-serif; cursor: pointer;
            transition: transform 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); float: right;
        }
        .tour-btn:hover { background: var(--forest-dark); transform: scale(1.05); }

        .tour-lang-btn {
            background: white; color: var(--forest-dark); border: 2px solid var(--forest-light);
            padding: 8px 15px; border-radius: 15px; font-weight: bold; cursor: pointer;
            font-family: 'Nunito', sans-serif; transition: all 0.2s; flex: 1; min-width: 80px; text-align: center;
        }
        .tour-lang-btn:hover { background: var(--forest-light); color: white; }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        @media (max-width: 768px) {
            header { padding: 20px 10px; }
            header img[alt="Community Logo"] { width: 45px !important; height: 45px !important; }
            header h1 { font-size: 1.3em; line-height: 1.3; }
            .lang-toggle { top: 22px; right: 65px; font-size: 0.85em; padding: 4px 8px; }
            .top-right-avatar { top: 15px; right: 10px; width: 35px; height: 35px; }
            .card { width: 95%; padding: 20px 15px; margin: 15px auto; }
            h2 { font-size: 1.3em; }
            .welcome-header { flex-direction: column; text-align: center; justify-content: center; }
            #welcomeText { font-size: 1.2em !important; line-height: 1.4; }
            .action-buttons { width: 100%; justify-content: center; }
            .action-buttons button { flex: 1; min-width: 120px; padding: 12px; font-size: 14px; }
            #map { height: 300px; }
            #timer { font-size: 1.2em; padding: 12px 20px; width: 100%; box-sizing: border-box; }
            .modal-content { padding: 30px 20px; width: 92%; }
            .modal-content input[type="text"], .modal-content select { width: 100%; }
            .leaderboard-item { font-size: 0.95em; padding: 12px; }
            .leaderboard-item img, .leaderboard-item div[style*="border-radius: 50%"] { width: 28px !important; height: 28px !important; font-size: 14px !important; }
            .tour-dialog { width: 95%; padding: 15px; }
            .tour-character { width: 60px; height: 60px; font-size: 35px; }
        }
    </style>
</head>

<body>

<div id="tourOverlayBg" class="tour-overlay-bg"></div>

<div id="tourDialog" class="tour-dialog">
    <div class="tour-character">üê¶</div>
    <div class="tour-content">
        <h3 id="tourTitle">Loading...</h3>
        <p id="tourText">Loading tour text...</p>
        
        <div id="tourCustomButtons" style="display: none; gap: 10px; flex-wrap: wrap; margin-top: 15px;"></div>
        <button id="tourNextBtn" class="tour-btn">Next ‚û°</button>
    </div>
</div>

<div id="loginOverlay" class="modal-overlay">
    <div class="modal-content">
        <h2 style="border:none; margin-top: 15px;" data-en="Join the Flock üåø" data-gu="‡™∏‡™Æ‡´Å‡™¶‡™æ‡™Ø‡™Æ‡™æ‡™Ç ‡™ú‡´ã‡™°‡™æ‡™ì üåø" data-hi="‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç üåø">Join the Flock üåø</h2>
        
        <div style="margin-bottom: 15px;">
            <label for="profilePicInput" style="cursor: pointer; display: inline-block;">
                <img id="profilePreview" src="logoo.png" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent-leaf); object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                <p style="margin: 5px 0 0 0; font-size: 0.9em; color: var(--forest-light); font-weight: bold;" data-en="üì∑ Choose Avatar" data-gu="üì∑ ‡™Ö‡™µ‡™§‡™æ‡™∞ ‡™™‡™∏‡™Ç‡™¶ ‡™ï‡™∞‡´ã" data-hi="üì∑ ‡§Ö‡§µ‡§§‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç">üì∑ Choose Avatar</p>
            </label>
            <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
        </div>

        <input type="text" id="usernameInput" data-ph-en="Bird Feeder Name..." data-ph-gu="‡™§‡™Æ‡™æ‡™∞‡´Å‡™Ç ‡™®‡™æ‡™Æ..." data-ph-hi="‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ..." placeholder="Bird Feeder Name..." autocomplete="off" />
        <p style="margin-bottom: 5px; font-weight: bold;" data-en="What are you feeding today?" data-gu="‡™Ü‡™ú‡´á ‡™§‡™Æ‡´á ‡™∂‡´Å‡™Ç ‡™ñ‡™µ‡™°‡™æ‡™µ‡´Ä ‡™∞‡™π‡´ç‡™Ø‡™æ ‡™õ‡´ã?" data-hi="‡§Ü‡§ú ‡§Ü‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§ñ‡§ø‡§≤‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç?">What are you feeding today?</p>
        <select id="foodInput">
            <option value="üåæ Seeds / Grains" data-en="üåæ Seeds / Grains" data-gu="üåæ ‡™¨‡´Ä‡™ú / ‡™¶‡™æ‡™£‡™æ" data-hi="üåæ ‡§¨‡•Ä‡§ú / ‡§Ö‡§®‡§æ‡§ú">üåæ Seeds / Grains</option>
            <option value="üíß Fresh Water" data-en="üíß Fresh Water" data-gu="üíß ‡™§‡™æ‡™ú‡´Å‡™Ç ‡™™‡™æ‡™£‡´Ä" data-hi="üíß ‡§§‡§æ‡§ú‡§æ ‡§™‡§æ‡§®‡•Ä">üíß Fresh Water</option>
            <option value="üçé Fruit" data-en="üçé Fruit" data-gu="üçé ‡™´‡™≥" data-hi="üçé ‡§´‡§≤">üçé Fruit</option>
            <option value="üçû Roti / Bread" data-en="üçû Roti / Bread" data-gu="üçû ‡™∞‡´ã‡™ü‡™≤‡´Ä / ‡™¨‡´ç‡™∞‡´á‡™°" data-hi="üçû ‡§∞‡•ã‡§ü‡•Ä / ‡§¨‡•ç‡§∞‡•á‡§°">üçû Roti / Bread</option>
        </select>
        <br>
        <button id="joinBtn" class="btn" style="margin-top: 10px;" data-en="Join Community" data-gu="‡™ú‡´ã‡™°‡™æ‡™ì" data-hi="‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç">Join Community</button>
    </div>
</div>

<div id="editProfileOverlay" class="modal-overlay">
    <div class="modal-content">
        <h2 style="border:none;" data-en="Edit Profile ‚úèÔ∏è" data-gu="‡™™‡´ç‡™∞‡´ã‡™´‡™æ‡™á‡™≤ ‡™¨‡™¶‡™≤‡´ã ‚úèÔ∏è" data-hi="‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‚úèÔ∏è">Edit Profile ‚úèÔ∏è</h2>
        
        <div style="margin-bottom: 15px;">
            <label for="editProfilePicInput" style="cursor: pointer; display: inline-block;">
                <img id="editProfilePreview" src="logoo.png" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent-leaf); object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                <p style="margin: 5px 0 0 0; font-size: 0.9em; color: var(--forest-light); font-weight: bold;" data-en="üì∑ Change Picture" data-gu="üì∑ ‡™´‡´ã‡™ü‡´ã ‡™¨‡™¶‡™≤‡´ã" data-hi="üì∑ ‡§´‡•ã‡§ü‡•ã ‡§¨‡§¶‡§≤‡•á‡§Ç">üì∑ Change Picture</p>
            </label>
            <input type="file" id="editProfilePicInput" accept="image/*" style="display: none;">
        </div>

        <input type="text" id="editUsernameInput" data-ph-en="New Name..." data-ph-gu="‡™®‡™µ‡´Å‡™Ç ‡™®‡™æ‡™Æ..." data-ph-hi="‡§®‡§Ø‡§æ ‡§®‡§æ‡§Æ..." placeholder="New Name..." autocomplete="off" />
        <br>
        <button id="saveProfileBtn" class="btn" style="margin-top: 10px; width: 100%;" data-en="Save Changes" data-gu="‡™∏‡™æ‡™ö‡™µ‡´ã" data-hi="‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç">Save Changes</button><br>
        <button id="closeProfileBtn" class="btn" style="background: transparent; color: #555; border: 2px solid #ccc; margin-top: 10px; box-shadow: none; width: 100%;" data-en="Cancel" data-gu="‡™∞‡™¶ ‡™ï‡™∞‡´ã" data-hi="‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç">Cancel</button>
    </div>
</div>

<header>
    <button id="langToggle" class="lang-toggle">üåê English</button>
    <img id="topRightAvatar" class="top-right-avatar" src="logoo.png" title="Edit Profile">

    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
        <img src="logoo.png" alt="Community Logo" style="width: 60px; height: 60px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
        <h1 style="margin: 0;" data-en="Jamnagar Bird Feeding Community" data-gu="‡™ú‡™æ‡™Æ‡™®‡™ó‡™∞ ‡™™‡™ï‡´ç‡™∑‡´Ä ‡™™‡™æ‡™≤‡™® ‡™∏‡™Æ‡´Å‡™¶‡™æ‡™Ø" data-hi="‡§ú‡§æ‡§Æ‡§®‡§ó‡§∞ ‡§™‡§ï‡•ç‡§∑‡•Ä ‡§´‡•Ä‡§°‡§ø‡§Ç‡§ó ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø">Jamnagar Bird Feeding Community</h1>
    </div>
    <p style="margin: 0; font-size: 0.9em;" data-en="Feed Birds ‚Ä¢ Help Nature ‚Ä¢ Build Community" data-gu="‡™™‡™ï‡´ç‡™∑‡´Ä‡™ì‡™®‡´á ‡™ñ‡™µ‡™°‡™æ‡™µ‡´ã ‚Ä¢ ‡™™‡´ç‡™∞‡™ï‡´É‡™§‡™ø‡™®‡´á ‡™Æ‡™¶‡™¶ ‡™ï‡™∞‡´ã ‚Ä¢ ‡™∏‡™Æ‡´Å‡™¶‡™æ‡™Ø ‡™¨‡™®‡™æ‡™µ‡´ã" data-hi="‡§™‡§ï‡•ç‡§∑‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ñ‡§ø‡§≤‡§æ‡§è‡§Ç ‚Ä¢ ‡§™‡•ç‡§∞‡§ï‡•É‡§§‡§ø ‡§ï‡•Ä ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡•á‡§Ç ‚Ä¢ ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§¨‡§®‡§æ‡§è‡§Ç">Feed Birds ‚Ä¢ Help Nature ‚Ä¢ Build Community</p>
</header>

<div id="timeBanner">Loading...</div>

<section class="card">
    <div class="welcome-header">
        <h2 id="welcomeText" style="margin: 0; border: none; font-size: 1.4em;">Welcome... üçÉ</h2>
        
        <div class="action-buttons">
            <button id="openTutorialBtn" class="help-btn" data-en="‚ùì How it works" data-gu="‚ùì ‡™ï‡´á‡™µ‡´Ä ‡™∞‡´Ä‡™§‡´á ‡™µ‡™æ‡™™‡™∞‡™µ‡´Å‡™Ç" data-hi="‚ùì ‡§Ø‡§π ‡§ï‡•à‡§∏‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à">‚ùì How it works</button>
            <button id="shareWhatsAppBtn" class="whatsapp-btn" data-en="üí¨ Invite Friends" data-gu="üí¨ ‡™Æ‡™ø‡™§‡´ç‡™∞‡´ã‡™®‡´á ‡™Ü‡™Æ‡™Ç‡™§‡´ç‡™∞‡™ø‡™§ ‡™ï‡™∞‡´ã" data-hi="üí¨ ‡§¶‡•ã‡§∏‡•ç‡§§‡•ã‡§Ç ‡§ï‡•ã ‡§Ü‡§Æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç">üí¨ Invite Friends</button>
            <button id="installAppBtn" class="install-btn" data-en="üì≤ Install App" data-gu="üì≤ ‡™è‡™™ ‡™°‡™æ‡™â‡™®‡™≤‡´ã‡™° ‡™ï‡™∞‡´ã" data-hi="üì≤ ‡§ê‡§™ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç">üì≤ Install App</button>
            <button id="logoutBtn" class="logout-btn" data-en="Log Out" data-gu="‡™≤‡´â‡™ó ‡™Ü‡™â‡™ü" data-hi="‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü">Log Out</button>
        </div>
    </div>
    
    <div class="stats-container">
        <p style="font-size: 1.2em; margin: 0;"><b data-en="üü¢ Online Now:" data-gu="üü¢ ‡™ì‡™®‡™≤‡™æ‡™á‡™®:" data-hi="üü¢ ‡§ë‡§®‡§≤‡§æ‡§á‡§®:">üü¢ Online Now:</b> <span id="counter" style="color: var(--forest-light); font-weight: 800; font-size: 1.4em;">0</span></p>
        <p style="font-size: 1.1em; margin: 0; color: #555;"><b data-en="üí§ Offline:" data-gu="üí§ ‡™ë‡™´‡™≤‡™æ‡™á‡™®:" data-hi="üí§ ‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§®:">üí§ Offline:</b> <span id="offlineCounter" style="font-weight: bold;">0</span></p>
    </div>
</section>

<section class="card emergency-card">
    <h2 data-en="üöë Jamnagar Bird SOS" data-gu="üöë ‡™ú‡™æ‡™Æ‡™®‡™ó‡™∞ ‡™™‡™ï‡´ç‡™∑‡´Ä SOS" data-hi="üöë ‡§ú‡§æ‡§Æ‡§®‡§ó‡§∞ ‡§™‡§ï‡•ç‡§∑‡•Ä SOS">üöë Jamnagar Bird SOS</h2>
    <p style="margin-top: 0;" data-en="Found an injured or dehydrated bird? Please do not try to treat it yourself. Contact our local Jamnagar experts immediately:" data-gu="‡™ò‡™æ‡™Ø‡™≤ ‡™Ö‡™•‡™µ‡™æ ‡™§‡™∞‡™∏‡´ç‡™Ø‡´Å‡™Ç ‡™™‡™ï‡´ç‡™∑‡´Ä ‡™Æ‡™≥‡´ç‡™Ø‡´Å‡™Ç? ‡™ï‡´É‡™™‡™æ ‡™ï‡™∞‡´Ä‡™®‡´á ‡™ú‡™æ‡™§‡´á ‡™∏‡™æ‡™∞‡™µ‡™æ‡™∞ ‡™ï‡™∞‡™µ‡™æ‡™®‡´ã ‡™™‡´ç‡™∞‡™Ø‡™æ‡™∏ ‡™ï‡™∞‡™∂‡´ã ‡™®‡™π‡´Ä‡™Ç. ‡™Ö‡™Æ‡™æ‡™∞‡™æ ‡™∏‡´ç‡™•‡™æ‡™®‡™ø‡™ï ‡™ú‡™æ‡™Æ‡™®‡™ó‡™∞ ‡™®‡™ø‡™∑‡´ç‡™£‡™æ‡™§‡´ã‡™®‡´ã ‡™§‡™æ‡™§‡´ç‡™ï‡™æ‡™≤‡™ø‡™ï ‡™∏‡™Ç‡™™‡™∞‡´ç‡™ï ‡™ï‡™∞‡´ã:" data-hi="‡§ò‡§æ‡§Ø‡§≤ ‡§Ø‡§æ ‡§™‡•ç‡§Ø‡§æ‡§∏‡§æ ‡§™‡§ï‡•ç‡§∑‡•Ä ‡§Æ‡§ø‡§≤‡§æ? ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•ç‡§µ‡§Ø‡§Ç ‡§á‡§≤‡§æ‡§ú ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§π‡§Æ‡§æ‡§∞‡•á ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§ú‡§æ‡§Æ‡§®‡§ó‡§∞ ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û‡•ã‡§Ç ‡§∏‡•á ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç:">Found an injured or dehydrated bird? Please do not try to treat it yourself. Contact our local Jamnagar experts immediately:</p>
    <ul class="info-list" style="border-left-color: var(--alert-red); margin-top: 15px;">
        <li>üìû <b>Jivdaya Charitable Trust:</b> +91 99244 18184</li>
        <li>üìû <b>Animal Welfare Trust:</b> +91 92275 55108</li>
        <li>üìû <b>Forest Dept Wildlife Helpline:</b> +91 94295 19492</li>
    </ul>
</section>

<section class="card" id="gatheringSpotCard">
    <h2 id="gatheringHeader">üìç Today's Gathering Spot</h2><br>
    <div style="background: rgba(64, 145, 108, 0.1); padding: 15px; border-radius: 12px; border: 1px solid var(--forest-light); display: inline-block; margin-bottom: 15px;">
        <p id="meetingLocationText" style="font-size: 1.2em; margin: 0; color: var(--forest-dark);"></p>
    </div>
    <p><b data-en="Times:" data-gu="‡™∏‡™Æ‡™Ø:" data-hi="‡§∏‡§Æ‡§Ø:">Times:</b> <span data-en="8:00 AM & 5:30 PM" data-gu="‡™∏‡™µ‡™æ‡™∞‡´á 8:00 ‡™Ö‡™®‡´á ‡™∏‡™æ‡™Ç‡™ú‡´á 5:30" data-hi="‡§∏‡•Å‡§¨‡§π 8:00 ‡§î‡§∞ ‡§∂‡§æ‡§Æ 5:30">8:00 AM & 5:30 PM</span> <b style="color:var(--forest-light);" data-en="(Each session lasts 1.5 Hours)" data-gu="(‡™¶‡™∞‡´á‡™ï ‡™∏‡™§‡´ç‡™∞ 1.5 ‡™ï‡™≤‡™æ‡™ï ‡™ö‡™æ‡™≤‡´á ‡™õ‡´á)" data-hi="(‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§∏‡§§‡•ç‡§∞ 1.5 ‡§ò‡§Ç‡§ü‡•á ‡§ö‡§≤‡§§‡§æ ‡§π‡•à)">(Each session lasts 1.5 Hours)</b></p>
    <h3 id="meetingLabel" style="color: var(--forest-dark); margin-top: 15px;">‚è≥ Time Left Until Next Gathering</h3>
    <div id="timer">Calculating...</div>
    
    <p style="margin-top: 15px; margin-bottom: 0;" data-en="Check the map below to see exactly where to go!" data-gu="‡™ï‡´ç‡™Ø‡™æ‡™Ç ‡™ú‡™µ‡´Å‡™Ç ‡™§‡´á ‡™ú‡´ã‡™µ‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™®‡´Ä‡™ö‡´á‡™®‡´ã ‡™®‡™ï‡™∂‡´ã ‡™§‡™™‡™æ‡™∏‡´ã!" data-hi="‡§ï‡§π‡§æ‡§Å ‡§ú‡§æ‡§®‡§æ ‡§π‡•à ‡§Ø‡§π ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡•Ä‡§ö‡•á ‡§¶‡§ø‡§è ‡§ó‡§è ‡§Æ‡§æ‡§®‡§ö‡§ø‡§§‡•ç‡§∞ ‡§ï‡•ã ‡§¶‡•á‡§ñ‡•á‡§Ç!">Check the map below to see exactly where to go!</p>
    <div id="map" style="margin-top: 10px;"></div>
</section>

<section class="card" id="ai-section">
    <h2 data-en="ü§ñ AI Bird Verifier" data-gu="ü§ñ AI ‡™™‡™ï‡´ç‡™∑‡´Ä ‡™ö‡™ï‡™æ‡™∏‡™£‡´Ä" data-hi="ü§ñ AI ‡§™‡§ï‡•ç‡§∑‡•Ä ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§®">ü§ñ AI Bird Verifier</h2>
    <p data-en="Upload a photo of you feeding the birds today. Our AI will verify the image to build your daily streak!" data-gu="‡™Ü‡™ú‡´á ‡™™‡™ï‡´ç‡™∑‡´Ä‡™ì‡™®‡´á ‡™ñ‡™µ‡™°‡™æ‡™µ‡™§‡´ã ‡™§‡™Æ‡™æ‡™∞‡´ã ‡™´‡´ã‡™ü‡´ã ‡™Ö‡™™‡™≤‡´ã‡™° ‡™ï‡™∞‡´ã. ‡™Ö‡™Æ‡™æ‡™∞‡´Å‡™Ç AI ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™¶‡´à‡™®‡™ø‡™ï ‡™∏‡´ç‡™ü‡´ç‡™∞‡´Ä‡™ï ‡™¨‡™®‡™æ‡™µ‡™µ‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™õ‡™¨‡´Ä‡™®‡´á ‡™ö‡™ï‡™æ‡™∏‡™∂‡´á!" data-hi="‡§Ü‡§ú ‡§™‡§ï‡•ç‡§∑‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ñ‡§ø‡§≤‡§æ‡§§‡•á ‡§π‡•Å‡§è ‡§Ö‡§™‡§®‡•Ä ‡§è‡§ï ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§π‡§Æ‡§æ‡§∞‡§æ AI ‡§Ü‡§™‡§ï‡•Ä ‡§¶‡•à‡§®‡§ø‡§ï ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§ï ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§õ‡§µ‡§ø ‡§ï‡•ã ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§ó‡§æ!">Upload a photo of you feeding the birds today. Our AI will verify the image to build your daily streak!</p>
    <input type="file" id="photoUpload" accept="image/*" style="display: none;">
    <label for="photoUpload" class="upload-label" id="uploadLabel" data-en="üì∑ Upload Feeding Photo" data-gu="üì∑ ‡™ñ‡™µ‡™°‡™æ‡™µ‡™§‡´ã ‡™´‡´ã‡™ü‡´ã ‡™Ö‡™™‡™≤‡´ã‡™° ‡™ï‡™∞‡´ã" data-hi="üì∑ ‡§´‡•Ä‡§°‡§ø‡§Ç‡§ó ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç">üì∑ Upload Feeding Photo</label>
    <div id="ai-status"></div>
</section>

<section class="card" id="leaderboardCard">
    <h2 data-en="üèÜ Top Jamnagar Feeders" data-gu="üèÜ ‡™ü‡´ã‡™ö‡™®‡™æ ‡™ú‡™æ‡™Æ‡™®‡™ó‡™∞ ‡™´‡´Ä‡™°‡™∞‡´ç‡™∏" data-hi="üèÜ ‡§∂‡•Ä‡§∞‡•ç‡§∑ ‡§ú‡§æ‡§Æ‡§®‡§ó‡§∞ ‡§´‡•Ä‡§°‡§∞">üèÜ Top Jamnagar Feeders</h2>
    <p data-en="Keep your daily streak alive to climb the ranks!" data-gu="‡™∞‡´á‡™®‡´ç‡™ï ‡™µ‡™ß‡™æ‡™∞‡™µ‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™¶‡´à‡™®‡™ø‡™ï ‡™∏‡´ç‡™ü‡´ç‡™∞‡´Ä‡™ï ‡™ö‡™æ‡™≤‡´Å ‡™∞‡™æ‡™ñ‡´ã!" data-hi="‡§∞‡•à‡§Ç‡§ï ‡§Æ‡•á‡§Ç ‡§ö‡§¢‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§™‡§®‡•Ä ‡§¶‡•à‡§®‡§ø‡§ï ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§ï ‡§ï‡•ã ‡§ú‡•Ä‡§µ‡§ø‡§§ ‡§∞‡§ñ‡•á‡§Ç!">Keep your daily streak alive to climb the ranks!</p>
    <ul id="leaderboard" class="leaderboard-list"></ul>
</section>

<footer>
    <p data-en="&copy; Herat Kotecha 2026" data-gu="&copy; ‡™π‡´á‡™∞‡™æ‡™§ ‡™ï‡´ã‡™ü‡´á‡™ö‡™æ ‡´®‡´¶‡´®‡´¨" data-hi="&copy; ‡§π‡•á‡§∞‡§§ ‡§ï‡•ã‡§ü‡•á‡§ö‡§æ 2026">&copy; Herat Kotecha 2026</p>
</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --- DICTIONARY FOR DYNAMIC JAVASCRIPT TEXTS ---
const tStrings = {
    en: {
        joining: "Joining... üåø", emptyName: "Name cannot be empty!", welcome: "Welcome back,", streak: "Day Streak",
        bannerLive: "üéâ The Gathering is Happening NOW! Go feed the birds and log your streak!",
        bannerNight: "üåô The birds are resting! Check the map for tomorrow's location. See you at 8:00 AM!",
        bannerDay: "‚òÄÔ∏è Perfect weather for bird feeding! Don't forget to upload your photo for a streak.",
        gatherLiveMorning: "üü¢ Morning Gathering is LIVE!", gatherLiveEvening: "üü¢ Evening Gathering is LIVE!",
        waitMorning: "‚è≥ Time Left Until Morning Gathering (8:00 AM)", waitEvening: "‚è≥ Time Left Until Evening Gathering (5:30 PM)", waitTomorrow: "‚è≥ Time Left Until Tomorrow's Morning Gathering", endsIn: "Ends in",
        aiSuccess: "‚úÖ Verified for today! Come back tomorrow.", aiScanning: "ü§ñ AI is looking for birds...", aiError: "‚ùå No bird found. Try a closer photo!", aiConnection: "‚ö†Ô∏è Connection Error. Try again!",
        inviteMsg: "Join the Jamnagar Bird Feeding Community! Plant your spot on the map, feed the birds, and build your streak. Let's help nature together! üê¶üìç Join here: https://7svg.github.io/birdfeeder/", streakMsg: "I'm on a {s}-day bird feeding streak! üî•",
        locToday: "Today's Gathering Spot", locTomorrow: "Tomorrow's Gathering Spot", locLabel: "Location:", noFeeders: "Loading... üçÉ",
        langBtn: "üåê English",
        t1Title: "Hi! I'm Chiku! üê¶", t1Text: "Welcome to the Jamnagar Bird Feeding Community. Let me show you how this works!",
        t2Title: "üìç The Gathering Spot", t2Text: "This section shows you exactly where we are feeding the birds today and at what time. Check the map!",
        t3Title: "üì∏ Feed & Verify", t3Text: "Go to the spot, feed the birds, and upload a quick photo here. My AI brain will verify it!",
        t4Title: "üèÜ The Leaderboard", t4Text: "Do it every day to keep your streak alive and climb to the top of the Jamnagar rankings!",
        tourNext: "Next ‚û°", tourDone: "Got it! Let's Go üåø", welcomeGuest: "Welcome to the Community! üåø"
    },
    gu: {
        joining: "‡™ú‡´ã‡™°‡™æ‡™à ‡™∞‡™π‡´ç‡™Ø‡™æ ‡™õ‡´Ä‡™è... üåø", emptyName: "‡™®‡™æ‡™Æ ‡™ñ‡™æ‡™≤‡´Ä ‡™® ‡™π‡´ã‡™à ‡™∂‡™ï‡´á!", welcome: "‡™∏‡´ç‡™µ‡™æ‡™ó‡™§ ‡™õ‡´á,", streak: "‡™¶‡™ø‡™µ‡™∏‡™®‡´Ä ‡™∏‡´ç‡™ü‡´ç‡™∞‡´Ä‡™ï",
        bannerLive: "üéâ ‡™Æ‡´á‡™≥‡™æ‡™µ‡™°‡´ã ‡™Ö‡™§‡´ç‡™Ø‡™æ‡™∞‡´á ‡™ö‡™æ‡™≤‡´Å ‡™õ‡´á! ‡™ú‡™æ‡™ì ‡™™‡™ï‡´ç‡™∑‡´Ä‡™ì‡™®‡´á ‡™ñ‡™µ‡™°‡™æ‡™µ‡´ã ‡™Ö‡™®‡´á ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™∏‡´ç‡™ü‡´ç‡™∞‡´Ä‡™ï ‡™®‡´ã‡™Ç‡™ß‡´ã!",
        bannerNight: "üåô ‡™™‡™ï‡´ç‡™∑‡´Ä‡™ì ‡™Ü‡™∞‡™æ‡™Æ ‡™ï‡™∞‡´Ä ‡™∞‡™π‡´ç‡™Ø‡™æ ‡™õ‡´á! ‡™Ü‡™µ‡™§‡´Ä‡™ï‡™æ‡™≤‡™®‡™æ ‡™∏‡´ç‡™•‡™æ‡™® ‡™Æ‡™æ‡™ü‡´á ‡™®‡™ï‡™∂‡´ã ‡™§‡™™‡™æ‡™∏‡´ã. ‡™∏‡™µ‡™æ‡™∞‡´á 8:00 ‡™µ‡™æ‡™ó‡´ç‡™Ø‡´á ‡™Æ‡™≥‡´Ä‡™è!",
        bannerDay: "‚òÄÔ∏è ‡™™‡™ï‡´ç‡™∑‡´Ä‡™ì‡™®‡´á ‡™ñ‡™µ‡™°‡™æ‡™µ‡™µ‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™â‡™§‡´ç‡™§‡™Æ ‡™π‡™µ‡™æ‡™Æ‡™æ‡™®! ‡™∏‡´ç‡™ü‡´ç‡™∞‡´Ä‡™ï ‡™Æ‡™æ‡™ü‡´á ‡™§‡™Æ‡™æ‡™∞‡´ã ‡™´‡´ã‡™ü‡´ã ‡™Ö‡™™‡™≤‡´ã‡™° ‡™ï‡™∞‡™µ‡™æ‡™®‡´Å‡™Ç ‡™≠‡´Ç‡™≤‡™∂‡´ã ‡™®‡™π‡´Ä‡™Ç.",
        gatherLiveMorning: "üü¢ ‡™∏‡™µ‡™æ‡™∞‡™®‡´ã ‡™Æ‡´á‡™≥‡™æ‡™µ‡™°‡´ã ‡™ö‡™æ‡™≤‡´Å ‡™õ‡´á!", gatherLiveEvening: "üü¢ ‡™∏‡™æ‡™Ç‡™ú‡™®‡´ã ‡™Æ‡´á‡™≥‡™æ‡™µ‡™°‡´ã ‡™ö‡™æ‡™≤‡´Å ‡™õ‡´á!",
        waitMorning: "‚è≥ ‡™∏‡™µ‡™æ‡™∞‡™®‡™æ ‡™Æ‡´á‡™≥‡™æ‡™µ‡™°‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™¨‡™æ‡™ï‡´Ä ‡™∞‡™π‡´á‡™≤‡´ã ‡™∏‡™Æ‡™Ø (8:00 AM)", waitEvening: "‚è≥ ‡™∏‡™æ‡™Ç‡™ú‡™®‡™æ ‡™Æ‡´á‡™≥‡™æ‡™µ‡™°‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™¨‡™æ‡™ï‡´Ä ‡™∞‡™π‡´á‡™≤‡´ã ‡™∏‡™Æ‡™Ø (5:30 PM)", waitTomorrow: "‚è≥ ‡™Ü‡™µ‡™§‡´Ä‡™ï‡™æ‡™≤‡™®‡™æ ‡™∏‡™µ‡™æ‡™∞‡™®‡™æ ‡™Æ‡´á‡™≥‡™æ‡™µ‡™°‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™¨‡™æ‡™ï‡´Ä ‡™∞‡™π‡´á‡™≤‡´ã ‡™∏‡™Æ‡™Ø", endsIn: "‡™™‡´Ç‡™∞‡´ç‡™£ ‡™•‡™∂‡´á",
        aiSuccess: "‚úÖ ‡™Ü‡™ú ‡™Æ‡™æ‡™ü‡´á ‡™ö‡™ï‡™æ‡™∏‡™æ‡™Ø‡´á‡™≤ ‡™õ‡´á! ‡™ï‡™æ‡™≤‡´á ‡™™‡™æ‡™õ‡™æ ‡™Ü‡™µ‡´ã.", aiScanning: "ü§ñ AI ‡™™‡™ï‡´ç‡™∑‡´Ä‡™ì ‡™∂‡´ã‡™ß‡´Ä ‡™∞‡™π‡´ç‡™Ø‡´Å‡™Ç ‡™õ‡´á...", aiError: "‚ùå ‡™ï‡´ã‡™à ‡™™‡™ï‡´ç‡™∑‡´Ä ‡™Æ‡™≥‡´ç‡™Ø‡´Å‡™Ç ‡™®‡™•‡´Ä. ‡™®‡™ú‡´Ä‡™ï‡™®‡´ã ‡™´‡´ã‡™ü‡´ã ‡™≤‡´ã!", aiConnection: "‚ö†Ô∏è ‡™ï‡™®‡´á‡™ï‡´ç‡™∂‡™® ‡™≠‡´Ç‡™≤. ‡™´‡™∞‡´Ä ‡™™‡´ç‡™∞‡™Ø‡™æ‡™∏ ‡™ï‡™∞‡´ã!",
        inviteMsg: "‡™ú‡™æ‡™Æ‡™®‡™ó‡™∞ ‡™™‡™ï‡´ç‡™∑‡´Ä ‡™™‡™æ‡™≤‡™® ‡™∏‡™Æ‡´Å‡™¶‡™æ‡™Ø‡™Æ‡™æ‡™Ç ‡™ú‡´ã‡™°‡™æ‡™ì! ‡™®‡™ï‡™∂‡™æ ‡™™‡™∞ ‡™§‡™Æ‡™æ‡™∞‡´Å‡™Ç ‡™∏‡´ç‡™•‡™æ‡™® ‡™®‡´ã‡™Ç‡™ß‡´ã, ‡™™‡™ï‡´ç‡™∑‡´Ä‡™ì‡™®‡´á ‡™ñ‡™µ‡™°‡™æ‡™µ‡´ã ‡™Ö‡™®‡´á ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™∏‡´ç‡™ü‡´ç‡™∞‡´Ä‡™ï ‡™¨‡™®‡™æ‡™µ‡´ã. ‡™ö‡™æ‡™≤‡´ã ‡™∏‡™æ‡™•‡´á ‡™Æ‡™≥‡´Ä‡™®‡´á ‡™™‡´ç‡™∞‡™ï‡´É‡™§‡™ø‡™®‡´á ‡™Æ‡™¶‡™¶ ‡™ï‡™∞‡´Ä‡™è! üê¶üìç ‡™Ö‡™π‡´Ä‡™Ç ‡™ú‡´ã‡™°‡™æ‡™ì: https://7svg.github.io/birdfeeder/", streakMsg: "‡™π‡´Å‡™Ç ‡™™‡™ï‡´ç‡™∑‡´Ä‡™ì‡™®‡´á ‡™ñ‡™µ‡™°‡™æ‡™µ‡™µ‡™æ‡™®‡´Ä {s}-‡™¶‡™ø‡™µ‡™∏‡™®‡´Ä ‡™∏‡´ç‡™ü‡´ç‡™∞‡´Ä‡™ï ‡™™‡™∞ ‡™õ‡´Å‡™Ç! üî•",
        locToday: "‡™Ü‡™ú‡™®‡´Å‡™Ç ‡™≠‡´á‡™ó‡™æ ‡™•‡™µ‡™æ‡™®‡´Å‡™Ç ‡™∏‡´ç‡™•‡™≥", locTomorrow: "‡™Ü‡™µ‡™§‡´Ä‡™ï‡™æ‡™≤‡™®‡´Å‡™Ç ‡™≠‡´á‡™ó‡™æ ‡™•‡™µ‡™æ‡™®‡´Å‡™Ç ‡™∏‡´ç‡™•‡™≥", locLabel: "‡™∏‡´ç‡™•‡™≥:", noFeeders: "‡™≤‡´ã‡™° ‡™•‡™à ‡™∞‡™π‡´ç‡™Ø‡´Å‡™Ç ‡™õ‡´á... üçÉ",
        langBtn: "üåê ‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä",
        t1Title: "‡™®‡™Æ‡™∏‡´ç‡™§‡´á! ‡™π‡´Å‡™Ç ‡™ö‡´Ä‡™ï‡´Å ‡™õ‡´Å‡™Ç! üê¶", t1Text: "‡™ú‡™æ‡™Æ‡™®‡™ó‡™∞ ‡™™‡™ï‡´ç‡™∑‡´Ä ‡™™‡™æ‡™≤‡™® ‡™∏‡™Æ‡´Å‡™¶‡™æ‡™Ø‡™Æ‡™æ‡™Ç ‡™§‡™Æ‡™æ‡™∞‡´Å‡™Ç ‡™∏‡´ç‡™µ‡™æ‡™ó‡™§ ‡™õ‡´á. ‡™ö‡™æ‡™≤‡´ã ‡™π‡´Å‡™Ç ‡™§‡™Æ‡™®‡´á ‡™¨‡™§‡™æ‡™µ‡´Å‡™Ç ‡™ï‡´á ‡™Ü ‡™ï‡´á‡™µ‡´Ä ‡™∞‡´Ä‡™§‡´á ‡™ï‡™æ‡™Æ ‡™ï‡™∞‡´á ‡™õ‡´á!",
        t2Title: "üìç ‡™≠‡´á‡™ó‡™æ ‡™•‡™µ‡™æ‡™®‡´Å‡™Ç ‡™∏‡´ç‡™•‡™≥", t2Text: "‡™Ü ‡™µ‡™ø‡™≠‡™æ‡™ó ‡™¨‡™§‡™æ‡™µ‡´á ‡™õ‡´á ‡™ï‡´á ‡™Ü‡™ú‡´á ‡™Ü‡™™‡™£‡´á ‡™ï‡´ç‡™Ø‡™æ‡™Ç ‡™Ö‡™®‡´á ‡™ï‡´á‡™ü‡™≤‡™æ ‡™µ‡™æ‡™ó‡´ç‡™Ø‡´á ‡™™‡™ï‡´ç‡™∑‡´Ä‡™ì‡™®‡´á ‡™ñ‡™µ‡™°‡™æ‡™µ‡´Ä‡™∂‡´Å‡™Ç. ‡™®‡™ï‡™∂‡´ã ‡™ú‡´Å‡™ì!",
        t3Title: "üì∏ ‡™ñ‡™µ‡™°‡™æ‡™µ‡´ã ‡™Ö‡™®‡´á ‡™ö‡™ï‡™æ‡™∏‡´ã", t3Text: "‡™§‡´ç‡™Ø‡™æ‡™Ç ‡™ú‡™æ‡™ì, ‡™™‡™ï‡´ç‡™∑‡´Ä‡™ì‡™®‡´á ‡™ñ‡™µ‡™°‡™æ‡™µ‡´ã, ‡™Ö‡™®‡´á ‡™Ö‡™π‡´Ä‡™Ç ‡™´‡´ã‡™ü‡´ã ‡™Ö‡™™‡™≤‡´ã‡™° ‡™ï‡™∞‡´ã. ‡™Æ‡™æ‡™∞‡´Å‡™Ç AI ‡™§‡´á‡™®‡´á ‡™ö‡™ï‡™æ‡™∏‡™∂‡´á!",
        t4Title: "üèÜ ‡™≤‡´Ä‡™°‡™∞‡™¨‡´ã‡™∞‡´ç‡™°", t4Text: "‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™∏‡´ç‡™ü‡´ç‡™∞‡´Ä‡™ï ‡™ú‡´Ä‡™µ‡™Ç‡™§ ‡™∞‡™æ‡™ñ‡™µ‡™æ ‡™Ö‡™®‡´á ‡™ú‡™æ‡™Æ‡™®‡™ó‡™∞‡™Æ‡™æ‡™Ç ‡™ü‡´ã‡™ö ‡™™‡™∞ ‡™™‡™π‡´ã‡™Ç‡™ö‡™µ‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™Ü ‡™¶‡™∞‡™∞‡´ã‡™ú ‡™ï‡™∞‡´ã!",
        tourNext: "‡™Ü‡™ó‡™≥ ‚û°", tourDone: "‡™∏‡™Æ‡™ú‡™æ‡™à ‡™ó‡™Ø‡´Å‡™Ç! üåø", welcomeGuest: "‡™∏‡™Æ‡´Å‡™¶‡™æ‡™Ø‡™Æ‡™æ‡™Ç ‡™§‡™Æ‡™æ‡™∞‡´Å‡™Ç ‡™∏‡´ç‡™µ‡™æ‡™ó‡™§ ‡™õ‡´á! üåø"
    },
    hi: {
        joining: "‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç... üåø", emptyName: "‡§®‡§æ‡§Æ ‡§ñ‡§æ‡§≤‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ!", welcome: "‡§µ‡§æ‡§™‡§∏‡•Ä ‡§™‡§∞ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à,", streak: "‡§¶‡§ø‡§® ‡§ï‡•Ä ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§ï",
        bannerLive: "üéâ ‡§Ü‡§Ø‡•ã‡§ú‡§® ‡§Ö‡§≠‡•Ä ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à! ‡§ú‡§æ‡§è‡§Ç, ‡§™‡§ï‡•ç‡§∑‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ñ‡§ø‡§≤‡§æ‡§è‡§Ç ‡§î‡§∞ ‡§Ö‡§™‡§®‡•Ä ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§ï ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç!",
        bannerNight: "üåô ‡§™‡§ï‡•ç‡§∑‡•Ä ‡§Ü‡§∞‡§æ‡§Æ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç! ‡§ï‡§≤ ‡§ï‡•Ä ‡§ú‡§ó‡§π ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§ï‡•ç‡§∂‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§ ‡§∏‡•Å‡§¨‡§π 8:00 ‡§¨‡§ú‡•á ‡§Æ‡§ø‡§≤‡§§‡•á ‡§π‡•à‡§Ç!",
        bannerDay: "‚òÄÔ∏è ‡§™‡§ï‡•ç‡§∑‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ñ‡§ø‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§§‡•ç‡§§‡§Æ ‡§Æ‡•å‡§∏‡§Æ! ‡§Ö‡§™‡§®‡•Ä ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§ï ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ ‡§® ‡§≠‡•Ç‡§≤‡•á‡§Ç‡•§",
        gatherLiveMorning: "üü¢ ‡§∏‡•Å‡§¨‡§π ‡§ï‡§æ ‡§Ü‡§Ø‡•ã‡§ú‡§® ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à!", gatherLiveEvening: "üü¢ ‡§∂‡§æ‡§Æ ‡§ï‡§æ ‡§Ü‡§Ø‡•ã‡§ú‡§® ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à!",
        waitMorning: "‚è≥ ‡§∏‡•Å‡§¨‡§π ‡§ï‡•á ‡§Ü‡§Ø‡•ã‡§ú‡§® ‡§§‡§ï ‡§∂‡•á‡§∑ ‡§∏‡§Æ‡§Ø (8:00 AM)", waitEvening: "‚è≥ ‡§∂‡§æ‡§Æ ‡§ï‡•á ‡§Ü‡§Ø‡•ã‡§ú‡§® ‡§§‡§ï ‡§∂‡•á‡§∑ ‡§∏‡§Æ‡§Ø (5:30 PM)", waitTomorrow: "‚è≥ ‡§ï‡§≤ ‡§∏‡•Å‡§¨‡§π ‡§ï‡•á ‡§Ü‡§Ø‡•ã‡§ú‡§® ‡§§‡§ï ‡§∂‡•á‡§∑ ‡§∏‡§Æ‡§Ø", endsIn: "‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§ó‡§æ",
        aiSuccess: "‚úÖ ‡§Ü‡§ú ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§! ‡§ï‡§≤ ‡§µ‡§æ‡§™‡§∏ ‡§Ü‡§è‡§Ç‡•§", aiScanning: "ü§ñ AI ‡§™‡§ï‡•ç‡§∑‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§§‡§≤‡§æ‡§∂ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à...", aiError: "‚ùå ‡§ï‡•ã‡§à ‡§™‡§ï‡•ç‡§∑‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ ‡§ï‡§∞‡•Ä‡§¨ ‡§∏‡•á ‡§´‡•ã‡§ü‡•ã ‡§≤‡•á‡§Ç!", aiConnection: "‚ö†Ô∏è ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç!",
        inviteMsg: "‡§ú‡§æ‡§Æ‡§®‡§ó‡§∞ ‡§™‡§ï‡•ç‡§∑‡•Ä ‡§´‡•Ä‡§°‡§ø‡§Ç‡§ó ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç! ‡§®‡§ï‡•ç‡§∂‡•á ‡§™‡§∞ ‡§Ö‡§™‡§®‡•Ä ‡§ú‡§ó‡§π ‡§¨‡§®‡§æ‡§è‡§Ç, ‡§™‡§ï‡•ç‡§∑‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ñ‡§ø‡§≤‡§æ‡§è‡§Ç ‡§î‡§∞ ‡§Ö‡§™‡§®‡•Ä ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§ï ‡§¨‡§®‡§æ‡§è‡§Ç‡•§ ‡§Ü‡§á‡§è ‡§Æ‡§ø‡§≤‡§ï‡§∞ ‡§™‡•ç‡§∞‡§ï‡•É‡§§‡§ø ‡§ï‡•Ä ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡•á‡§Ç! üê¶üìç ‡§Ø‡§π‡§æ‡§Ç ‡§ú‡•Å‡§°‡§º‡•á‡§Ç: https://7svg.github.io/birdfeeder/", streakMsg: "‡§Æ‡•à‡§Ç {s}-‡§¶‡§ø‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§™‡§ï‡•ç‡§∑‡•Ä ‡§´‡•Ä‡§°‡§ø‡§Ç‡§ó ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§ï ‡§™‡§∞ ‡§π‡•Ç‡§Ç! üî•",
        locToday: "‡§Ü‡§ú ‡§ï‡•á ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§π‡•ã‡§®‡•á ‡§ï‡•Ä ‡§ú‡§ó‡§π", locTomorrow: "‡§ï‡§≤ ‡§ï‡•á ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§π‡•ã‡§®‡•á ‡§ï‡•Ä ‡§ú‡§ó‡§π", locLabel: "‡§∏‡•ç‡§•‡§æ‡§®:", noFeeders: "‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... üçÉ",
        langBtn: "üåê ‡§π‡§ø‡§Ç‡§¶‡•Ä",
        t1Title: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§ö‡•Ä‡§ï‡•Ç ‡§π‡•Ç‡§Å! üê¶", t1Text: "‡§ú‡§æ‡§Æ‡§®‡§ó‡§∞ ‡§¨‡§∞‡•ç‡§° ‡§´‡•Ä‡§°‡§ø‡§Ç‡§ó ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à‡•§ ‡§Ü‡§á‡§è ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•ã ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•Ç‡§Ç ‡§ï‡§ø ‡§Ø‡§π ‡§ï‡•à‡§∏‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à!",
        t2Title: "üìç ‡§á‡§ï‡§ü‡•ç‡§†‡§æ ‡§π‡•ã‡§®‡•á ‡§ï‡•Ä ‡§ú‡§ó‡§π", t2Text: "‡§Ø‡§π ‡§Ö‡§®‡•Å‡§≠‡§æ‡§ó ‡§¶‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§π‡§Æ ‡§Ü‡§ú ‡§™‡§ï‡•ç‡§∑‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ï‡§π‡§æ‡§Å ‡§î‡§∞ ‡§ï‡§ø‡§§‡§®‡•á ‡§¨‡§ú‡•á ‡§ñ‡§ø‡§≤‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§ ‡§®‡§ï‡•ç‡§∂‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç!",
        t3Title: "üì∏ ‡§ñ‡§ø‡§≤‡§æ‡§è‡§Ç ‡§î‡§∞ ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç", t3Text: "‡§â‡§∏ ‡§ú‡§ó‡§π ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç, ‡§™‡§ï‡•ç‡§∑‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ñ‡§ø‡§≤‡§æ‡§è‡§Ç, ‡§î‡§∞ ‡§Ø‡§π‡§æ‡§Ç ‡§è‡§ï ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Æ‡•á‡§∞‡§æ AI ‡§á‡§∏‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§ó‡§æ!",
        t4Title: "üèÜ ‡§≤‡•Ä‡§°‡§∞‡§¨‡•ã‡§∞‡•ç‡§°", t4Text: "‡§Ö‡§™‡§®‡•Ä ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§ï ‡§ï‡•ã ‡§ú‡•Ä‡§µ‡§ø‡§§ ‡§∞‡§ñ‡§®‡•á ‡§î‡§∞ ‡§ú‡§æ‡§Æ‡§®‡§ó‡§∞ ‡§Æ‡•á‡§Ç ‡§∂‡•Ä‡§∞‡•ç‡§∑ ‡§™‡§∞ ‡§™‡§π‡•Å‡§Ç‡§ö‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§á‡§∏‡•á ‡§π‡§∞ ‡§¶‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç!",
        tourNext: "‡§Ö‡§ó‡§≤‡§æ ‚û°", tourDone: "‡§∏‡§Æ‡§ù ‡§ó‡§Ø‡§æ! üåø", welcomeGuest: "‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à! üåø"
    }
};

let currentLang = localStorage.getItem('appLang');

function t(key) {
    if (!currentLang || !tStrings[currentLang]) return tStrings['en'][key] || key;
    return tStrings[currentLang][key] || key;
}

function applyTranslations() {
    if(!currentLang) return; 
    document.querySelectorAll('[data-en]').forEach(el => { el.innerHTML = el.getAttribute(`data-${currentLang}`); });
    document.querySelectorAll('[data-ph-en]').forEach(el => { el.placeholder = el.getAttribute(`data-ph-${currentLang}`); });
    
    document.getElementById('langToggle').innerHTML = t('langBtn');
    
    if (currentUserData) { updateWelcomeText(); } 
    else { document.getElementById("welcomeText").innerHTML = t('welcomeGuest'); }
    
    updateCountersAndLeaderboard(); checkTime(); initMap(); startTimer();
}

function showLanguagePrompt() {
    document.getElementById('tourOverlayBg').classList.add('active');
    document.getElementById('tourDialog').classList.add('active');
    
    document.getElementById('tourTitle').innerText = "Choose a language üåê";
    document.getElementById('tourText').innerText = "‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç ‚Ä¢ ‡™≠‡™æ‡™∑‡™æ ‡™™‡™∏‡™Ç‡™¶ ‡™ï‡™∞‡´ã";
    
    document.getElementById('tourNextBtn').style.display = 'none'; 
    
    let customBtns = document.getElementById('tourCustomButtons');
    customBtns.style.display = 'flex'; 
    customBtns.innerHTML = `
        <button class="tour-lang-btn" onclick="selectLangFromChiku('en')">English</button>
        <button class="tour-lang-btn" onclick="selectLangFromChiku('hi')">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
        <button class="tour-lang-btn" onclick="selectLangFromChiku('gu')">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</button>
    `;
}

function selectLangFromChiku(lang) {
    currentLang = lang;
    localStorage.setItem('appLang', lang);
    applyTranslations();
    
    document.getElementById('tourOverlayBg').classList.remove('active');
    document.getElementById('tourDialog').classList.remove('active');
    
    document.getElementById('tourNextBtn').style.display = 'block';
    document.getElementById('tourCustomButtons').style.display = 'none';
    
    if (!localStorage.getItem("currentUser")) {
        setTimeout(() => { document.getElementById('loginOverlay').classList.add('active'); }, 300);
    }
}

document.getElementById('langToggle').addEventListener('click', showLanguagePrompt);

let currentTourStep = 0;
const tourSteps = [
    { target: null, titleKey: 't1Title', textKey: 't1Text' },
    { target: 'gatheringSpotCard', titleKey: 't2Title', textKey: 't2Text' },
    { target: 'ai-section', titleKey: 't3Title', textKey: 't3Text' },
    { target: 'leaderboardCard', titleKey: 't4Title', textKey: 't4Text' }
];

function startTour() {
    currentTourStep = 0;
    document.getElementById('tourNextBtn').style.display = 'block';
    document.getElementById('tourCustomButtons').style.display = 'none';
    
    document.getElementById('tourOverlayBg').classList.add('active');
    document.getElementById('tourDialog').classList.add('active');
    setTimeout(showTourStep, 300); 
}

function showTourStep() {
    document.querySelectorAll('.highlighted-for-tour').forEach(el => el.classList.remove('highlighted-for-tour'));
    
    let step = tourSteps[currentTourStep];
    
    document.getElementById('tourTitle').innerText = t(step.titleKey);
    document.getElementById('tourText').innerText = t(step.textKey);
    
    if (step.target) {
        let targetEl = document.getElementById(step.target);
        targetEl.classList.add('highlighted-for-tour');
        const yOffset = -120; 
        const y = targetEl.getBoundingClientRect().top + window.pageYOffset + yOffset;
        window.scrollTo({top: Math.max(0, y), behavior: 'smooth'}); 
    } else {
        window.scrollTo({top: 0, behavior: 'smooth'});
    }
    
    let nextBtn = document.getElementById('tourNextBtn');
    if (currentTourStep === tourSteps.length - 1) { nextBtn.innerText = t('tourDone'); } 
    else { nextBtn.innerText = t('tourNext'); }
}

document.getElementById('tourNextBtn').addEventListener('click', () => {
    currentTourStep++;
    if (currentTourStep >= tourSteps.length) {
        document.getElementById('tourOverlayBg').classList.remove('active');
        document.getElementById('tourDialog').classList.remove('active');
        document.querySelectorAll('.highlighted-for-tour').forEach(el => el.classList.remove('highlighted-for-tour'));
        window.scrollTo({top: 0, behavior: 'smooth'});
    } else { showTourStep(); }
});

document.getElementById('openTutorialBtn').addEventListener('click', startTour);

let map;
let feeders = [];
let currentUserData = null;
let selectedProfilePic = null; 
let tempEditPic = null; 
let timerInterval;

let myDeviceId = localStorage.getItem("deviceId");
if (!myDeviceId) {
    myDeviceId = 'device-' + Math.random().toString(36).substr(2, 16) + Date.now().toString(36);
    localStorage.setItem("deviceId", myDeviceId);
}

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(() => console.log("Service Worker Registered"));
}

let deferredPrompt;
const installAppBtn = document.getElementById('installAppBtn');

window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });

installAppBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') { installAppBtn.style.display = 'none'; }
        deferredPrompt = null;
    } else {
        alert("To install the app:\n\nüì± iPhone (Safari): Tap the Share icon at the bottom and select 'Add to Home Screen'.\n\nüíª Android/Desktop: Click the install icon in your browser's address bar or menu.");
    }
});

document.getElementById('shareWhatsAppBtn').addEventListener('click', () => {
    let streakText = (currentUserData && currentUserData.streak > 0) ? t('streakMsg').replace('{s}', currentUserData.streak) + " " : "";
    let message = `üåø ${streakText}${t('inviteMsg')}`;
    let whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
});

function compressImage(file, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const size = 150; canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, size, size);
            let srcX = 0, srcY = 0, srcSize = Math.min(img.width, img.height);
            if (img.width > img.height) srcX = (img.width - img.height) / 2;
            else srcY = (img.height - img.width) / 2;
            ctx.drawImage(img, srcX, srcY, srcSize, srcSize, 0, 0, size, size);
            callback(canvas.toDataURL('image/jpeg', 0.8)); 
        }
        img.src = e.target.result;
    }
    reader.readAsDataURL(file);
}

document.getElementById('profilePicInput').addEventListener('change', function(e) {
    if (e.target.files.length > 0) { compressImage(e.target.files[0], (base64) => { selectedProfilePic = base64; document.getElementById('profilePreview').src = base64; }); }
});

const topRightAvatar = document.getElementById('topRightAvatar');
const editProfileOverlay = document.getElementById('editProfileOverlay');

topRightAvatar.addEventListener('click', () => {
    document.getElementById('editUsernameInput').value = currentUserData.username;
    document.getElementById('editProfilePreview').src = currentUserData.profilePic || 'logoo.png';
    tempEditPic = currentUserData.profilePic;
    editProfileOverlay.classList.add('active');
});

document.getElementById('editProfilePicInput').addEventListener('change', function(e) {
    if (e.target.files.length > 0) { compressImage(e.target.files[0], (base64) => { tempEditPic = base64; document.getElementById('editProfilePreview').src = base64; }); }
});

document.getElementById('saveProfileBtn').addEventListener('click', () => {
    let newName = document.getElementById('editUsernameInput').value.trim();
    if (!newName) { alert(t('emptyName')); return; }
    currentUserData.username = newName; currentUserData.profilePic = tempEditPic; localStorage.setItem("currentUser", newName); 
    editProfileOverlay.classList.remove('active'); updateWelcomeText(); updateCountersAndLeaderboard(); syncFeederData();
});

document.getElementById('closeProfileBtn').addEventListener('click', () => { editProfileOverlay.classList.remove('active'); });

const dailyLocations = [
    { name: "Lakhota Lake", lat: 22.4727, lng: 70.0637, desc: "City Center Waterfowl", color: "#1b4332", fill: "#40916c", radius: 600 },
    { name: "Khijadiya Bird Sanctuary", lat: 22.5160, lng: 70.1160, desc: "Ramsar Wetland Site", color: "#2980b9", fill: "#3498db", radius: 1000 },
    { name: "Ranjit Sagar Dam", lat: 22.3800, lng: 70.0800, desc: "Reservoir Birds", color: "#8e44ad", fill: "#9b59b6", radius: 800 },
    { name: "Rozi Port Wetlands", lat: 22.5450, lng: 70.0350, desc: "Coastal Waders & Flamingos", color: "#d35400", fill: "#e67e22", radius: 900 },
    { name: "Jogger's Park", lat: 22.4560, lng: 70.0630, desc: "Small Garden Birds & Pigeons", color: "#27ae60", fill: "#2ecc71", radius: 400 }
];

async function fetchAllFeeders() {
    try {
        let res = await fetch("https://heratofficial-birdfeeder.hf.space/get-feeders");
        let data = await res.json();
        if (Array.isArray(data)) {
            let uniqueFeeders = {};
            data.forEach(f => { if (f.deviceId) { uniqueFeeders[f.deviceId] = f; } else { uniqueFeeders[f.username] = f; } });
            feeders = Object.values(uniqueFeeders);
        } 
        updateCountersAndLeaderboard();
    } catch (e) { console.warn("Could not load global leaderboard."); }
}

async function syncFeederData() {
    if (!currentUserData) return;
    try {
        await fetch("https://heratofficial-birdfeeder.hf.space/sync-feeder", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(currentUserData) });
        fetchAllFeeders();
    } catch (e) { console.warn("Could not sync to server."); }
}

function getTodayLocation() {
    let now = new Date(); let localEpochMs = now.getTime() - (now.getTimezoneOffset() * 60000); let daysSinceEpoch = Math.floor(localEpochMs / 86400000);
    let isTomorrow = now.getHours() >= 19; if (isTomorrow) { daysSinceEpoch += 1; }
    return { loc: dailyLocations[daysSinceEpoch % dailyLocations.length], isTomorrow: isTomorrow };
}

function checkTime() {
    let now = new Date(), h = now.getHours(), m = now.getMinutes();
    let banner = document.getElementById("timeBanner");
    let isLive = (h === 8) || (h === 9 && m < 30) || (h === 17 && m >= 30) || (h === 18);
    if (isLive) { banner.className = "day-banner"; banner.innerHTML = t('bannerLive'); banner.style.background = "#27ae60"; banner.style.color = "white"; } 
    else if (h >= 19 || h < 6) { banner.className = "night-banner"; banner.innerHTML = t('bannerNight'); banner.style.background = ""; banner.style.color = ""; } 
    else { banner.className = "day-banner"; banner.innerHTML = t('bannerDay'); banner.style.background = ""; banner.style.color = ""; }
}

function initMap() {
    let { loc, isTomorrow } = getTodayLocation();
    let dayText = isTomorrow ? t('locTomorrow') : t('locToday');
    document.getElementById("gatheringHeader").innerText = `üìç ${dayText}`;
    document.getElementById("meetingLocationText").innerHTML = `<b style="color: #333;">${t('locLabel')}üìç ${loc.name}</b> <br><span style="font-size: 0.85em; color: #555;">(${loc.desc})</span>`;
    
    if (map) { map.remove(); }
    
    map = L.map('map', { scrollWheelZoom: false }).setView([loc.lat, loc.lng], 13);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 18 }).addTo(map);
    L.circle([loc.lat, loc.lng], { color: loc.color, weight: 3, fillColor: loc.fill, fillOpacity: 0.4, radius: loc.radius }).addTo(map)
      .bindPopup(`<b style='color: ${loc.color};'>üìç ${dayText}</b><br>${loc.name}`)
      .openPopup();
      
    updateCountersAndLeaderboard();
}

// ‚ú® THE FIX: REAL-TIME PRESENCE CHECK ‚ú®
function updateCountersAndLeaderboard() {
    let nowTime = Date.now();
    let onlineCount = 0;
    
    feeders.forEach(f => { 
        // A user is online ONLY if they pinged the server in the last 3 minutes (180000ms)
        if (f.lastPing && (nowTime - f.lastPing < 180000)) {
            onlineCount++;
        }
    });
    
    document.getElementById("counter").innerText = onlineCount;
    let offlineCount = feeders.length - onlineCount; 
    if (offlineCount < 0) offlineCount = 0;
    document.getElementById("offlineCounter").innerText = offlineCount;
    
    let list = document.getElementById("leaderboard"); list.innerHTML = ""; 
    let sortedFeeders = [...feeders].sort((a, b) => (b.streak || 0) - (a.streak || 0)).slice(0, 5);
    
    if (sortedFeeders.length === 0) { list.innerHTML = `<li style='text-align:center; color:#777;'>${t('noFeeders')}</li>`; return; }
    
    sortedFeeders.forEach((f, index) => {
        let li = document.createElement("li"); li.className = `leaderboard-item ${index < 3 ? 'rank-'+(index+1) : ''}`;
        let rankMedal = ["ü•á", "ü•à", "ü•â"][index] || `#${index + 1}`;
        let avatarHTML = f.profilePic ? `<img src="${f.profilePic}" style="width: 34px; height: 34px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">` : `<div style="width: 34px; height: 34px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid var(--accent-leaf);">üê¶</div>`;

        li.innerHTML = `<div style="display: flex; align-items: center; gap: 12px;"><span style="width: 25px; text-align: center;">${rankMedal}</span>${avatarHTML}<span>${f.username}</span></div><span>üî• ${f.streak || 0}</span>`;
        list.appendChild(li);
    });
}

function startTimer() {
    if(timerInterval) clearInterval(timerInterval);
    function updateTimer() {
        let now = new Date();
        let morningStart = new Date(); morningStart.setHours(8,0,0,0); let morningEnd = new Date(); morningEnd.setHours(9,30,0,0);
        let eveningStart = new Date(); eveningStart.setHours(17,30,0,0); let eveningEnd = new Date(); eveningEnd.setHours(19,0,0,0);
        let targetTime, label = document.getElementById("meetingLabel"), timerDiv = document.getElementById("timer");
        
        if (now >= morningStart && now < morningEnd) { label.innerText = t('gatherLiveMorning'); targetTime = morningEnd; } 
        else if (now >= eveningStart && now < eveningEnd) { label.innerText = t('gatherLiveEvening'); targetTime = eveningEnd; } 
        else if (now < morningStart) { label.innerText = t('waitMorning'); targetTime = morningStart; } 
        else if (now < eveningStart) { label.innerText = t('waitEvening'); targetTime = eveningStart; } 
        else { targetTime = new Date(morningStart); targetTime.setDate(targetTime.getDate() + 1); label.innerText = t('waitTomorrow'); }
        
        let diff = targetTime - now; let h = Math.floor(diff / (1000*60*60)), m = Math.floor((diff % (1000*60*60)) / (1000*60)), s = Math.floor((diff % (1000*60)) / 1000);
        
        if ((now >= morningStart && now < morningEnd) || (now >= eveningStart && now < eveningEnd)) {
            timerDiv.innerHTML = `${t('endsIn')}: ${h}h : ${m < 10 ? '0'+m : m}m : ${s < 10 ? '0'+s : s}s`; timerDiv.style.background = "linear-gradient(135deg, #e74c3c, #c0392b)";
        } else {
            timerDiv.innerHTML = `${h < 10 ? '0'+h : h}h : ${m < 10 ? '0'+m : m}m : ${s < 10 ? '0'+s : s}s`; timerDiv.style.background = "linear-gradient(135deg, var(--forest-light), var(--forest-dark))";
        }
    }
    updateTimer(); timerInterval = setInterval(updateTimer,1000);
}

function setupAIVerification() {
    document.getElementById("ai-section").style.display = "block"; 
    const fileInput = document.getElementById("photoUpload"); const statusDiv = document.getElementById("ai-status"); const uploadLabel = document.getElementById("uploadLabel");
    let today = new Date().toDateString();

    if(currentUserData.lastVerified === today) { uploadLabel.style.display = "none"; statusDiv.innerHTML = `<span class="success">${t('aiSuccess')}</span>`; return; }

    fileInput.addEventListener("change", async function() {
        if(this.files.length > 0) {
            uploadLabel.style.display = "none"; statusDiv.innerHTML = `<span class="scanning">${t('aiScanning')}</span>`;
            let formData = new FormData(); formData.append("image", this.files[0]);

            try {
                let response = await fetch("https://heratofficial-birdfeeder.hf.space/verify-bird", { method: "POST", body: formData });
                let result = await response.json();

                if (result.success) {
                    currentUserData.streak = (currentUserData.streak || 0) + 1; currentUserData.lastVerified = today;
                    statusDiv.innerHTML = `<span class="success">‚úÖ ${result.message}</span>`;
                    updateWelcomeText(); syncFeederData(); 
                } else { uploadLabel.style.display = "inline-block"; statusDiv.innerHTML = `<span style="color:#e74c3c;">${t('aiError')}</span>`; }
            } catch (error) { uploadLabel.style.display = "inline-block"; statusDiv.innerHTML = `<span style="color:#e74c3c;">${t('aiConnection')}</span>`; }
        }
    });
}

function updateWelcomeText() {
    let s = currentUserData.streak > 0 ? `<span class="streak-badge">üî• ${currentUserData.streak} ${t('streak')}</span>` : "";
    document.getElementById("welcomeText").innerHTML = `${t('welcome')} ${currentUserData.username} üåø ${s}`;
    topRightAvatar.style.display = "block";
    if (currentUserData.profilePic) { topRightAvatar.src = currentUserData.profilePic; } else { topRightAvatar.src = "logoo.png"; }
}

function setupLogout() {
    let logoutBtn = document.getElementById("logoutBtn"); logoutBtn.style.display = "block"; 
    logoutBtn.addEventListener("click", () => { localStorage.removeItem("currentUser"); location.reload(); });
}

function startApp() {
    document.getElementById("joinBtn").addEventListener("click", () => {
        let username = document.getElementById("usernameInput").value.trim(); let foodChoice = document.getElementById("foodInput").value;
        if(!username){ alert(t('emptyName')); return; }
        
        let btn = document.getElementById("joinBtn"); btn.disabled = true; btn.innerText = t('joining');
        
        // Add lastPing to new user data
        currentUserData = { deviceId: myDeviceId, username: username, food: foodChoice, profilePic: selectedProfilePic, streak: 0, lastVerified: null, lastPing: Date.now() };
        
        localStorage.setItem("currentUser", username); 
        syncFeederData(); 
        
        updateWelcomeText(); setupLogout(); setupAIVerification(); 
        document.getElementById('loginOverlay').classList.remove("active"); 
        
        if (!localStorage.getItem('hasSeenTutorial')) {
            setTimeout(() => { startTour(); localStorage.setItem('hasSeenTutorial', 'true'); }, 600); 
        }
    });

    if (!currentLang) {
        showLanguagePrompt(); 
    } else {
        applyTranslations(); 
        if (!localStorage.getItem("currentUser")) { document.getElementById('loginOverlay').classList.add('active'); }
    }

    let savedUsername = localStorage.getItem("currentUser");
    
    if (savedUsername) {
        currentUserData = { deviceId: myDeviceId, username: savedUsername, food: "üåæ Seeds / Grains", profilePic: null, streak: 0, lastVerified: null, lastPing: Date.now() };
        updateWelcomeText(); setupLogout(); setupAIVerification(); 
    }

    fetchAllFeeders().then(() => {
        if (savedUsername) {
            let foundUser = feeders.find(f => f.deviceId === myDeviceId);
            if (foundUser) {
                currentUserData = foundUser; 
                currentUserData.lastPing = Date.now();
                syncFeederData(); updateWelcomeText();
            }
        }
    });

    // ‚ú® THE FIX: PAGE VISIBILITY API LOOP ‚ú®
    setInterval(() => {
        // If the user has an account AND their screen is turned on/visible
        if (currentUserData && document.visibilityState === 'visible') {
            currentUserData.lastPing = Date.now();
            syncFeederData(); // Pings server saying "I'm still here!"
        } else {
            fetchAllFeeders(); // Just get data from server quietly
        }
    }, 30000); 
}

startApp();
</script>
</body>
</html>
