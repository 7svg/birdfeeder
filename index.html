\<script>
let map;
let feeders = [];
let currentUserData = null;

// --- NEW: DEVICE ID GENERATOR ---
// This creates a permanent ID for this specific phone/computer
let myDeviceId = localStorage.getItem("deviceId");
if (!myDeviceId) {
    // Generate a random ID like 'device-xyz123abc'
    myDeviceId = 'device-' + Math.random().toString(36).substr(2, 16) + Date.now().toString(36);
    localStorage.setItem("deviceId", myDeviceId);
}
// --------------------------------

const colorfulBirdIcon = L.divIcon({
    html: `<div style="background: linear-gradient(135deg, #40916c, #1b4332); width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 2px 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;"><span style="transform: rotate(45deg); font-size: 16px;">üê¶</span></div>`,
    className: 'custom-pin', iconSize: [36, 36], iconAnchor: [18, 36], popupAnchor: [0, -38]
});

const dailyLocations = [
    { name: "Lakhota Lake", lat: 22.4727, lng: 70.0637, desc: "City Center Waterfowl", color: "#1b4332", fill: "#40916c", radius: 600 },
    { name: "Khijadiya Bird Sanctuary", lat: 22.5160, lng: 70.1160, desc: "Ramsar Wetland Site", color: "#2980b9", fill: "#3498db", radius: 1000 },
    { name: "Ranjit Sagar Dam", lat: 22.3800, lng: 70.0800, desc: "Reservoir Birds", color: "#8e44ad", fill: "#9b59b6", radius: 800 },
    { name: "Rozi Port Wetlands", lat: 22.5450, lng: 70.0350, desc: "Coastal Waders & Flamingos", color: "#d35400", fill: "#e67e22", radius: 900 },
    { name: "Jogger's Park", lat: 22.4560, lng: 70.0630, desc: "Small Garden Birds & Pigeons", color: "#27ae60", fill: "#2ecc71", radius: 400 }
];

async function fetchAllFeeders() {
    try {
        let res = await fetch("https://heratofficial-birdfeeder.hf.space/get-feeders");
        let data = await res.json();
        if (Array.isArray(data)) feeders = data; 
        
        if (map) {
            map.eachLayer((layer) => { if (layer instanceof L.Marker) { layer.remove(); } }); 
            updateMarkers();
        }
    } catch (e) {
        console.warn("Could not load global leaderboard.");
    }
}

async function syncFeederData() {
    if (!currentUserData) return;
    try {
        await fetch("https://heratofficial-birdfeeder.hf.space/sync-feeder", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify(currentUserData)
        });
        await fetchAllFeeders(); 
    } catch (e) {
        console.warn("Could not sync to server.");
    }
}

function getTodayLocation() {
    let now = new Date();
    let localEpochMs = now.getTime() - (now.getTimezoneOffset() * 60000);
    let daysSinceEpoch = Math.floor(localEpochMs / 86400000);
    let isTomorrow = now.getHours() >= 19;
    if (isTomorrow) { daysSinceEpoch += 1; }
    return { loc: dailyLocations[daysSinceEpoch % dailyLocations.length], isTomorrow: isTomorrow };
}

function checkTime() {
    let now = new Date();
    let h = now.getHours(), m = now.getMinutes();
    let banner = document.getElementById("timeBanner");
    let isLive = (h === 8) || (h === 9 && m < 30) || (h === 17 && m >= 30) || (h === 18);
    if (isLive) {
        banner.className = "day-banner";
        banner.innerHTML = "üéâ The Gathering is Happening NOW! Go feed the birds and log your streak!";
        banner.style.background = "#27ae60"; banner.style.color = "white";
    } else if (h >= 19 || h < 6) {
        banner.className = "night-banner";
        banner.innerHTML = "üåô The birds are resting! Check the map for tomorrow's location. See you at 8:00 AM!";
        banner.style.background = ""; banner.style.color = "";
    } else {
        banner.className = "day-banner";
        banner.innerHTML = "‚òÄÔ∏è Perfect weather for bird feeding! Don't forget to upload your photo for a streak.";
        banner.style.background = ""; banner.style.color = "";
    }
}

function initMap() {
    let { loc, isTomorrow } = getTodayLocation();
    let dayText = isTomorrow ? "Tomorrow's" : "Today's";
    document.getElementById("gatheringHeader").innerText = `üìç ${dayText} Gathering Spot`;
    document.getElementById("meetingLocationText").innerHTML = `<b>üìç ${loc.name}</b> <br><span style="font-size: 0.85em; color: #555;">(${loc.desc})</span>`;
    
    map = L.map('map', { scrollWheelZoom: false }).setView([loc.lat, loc.lng], 13);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 18 }).addTo(map);
    L.circle([loc.lat, loc.lng], { color: loc.color, weight: 3, fillColor: loc.fill, fillOpacity: 0.4, radius: loc.radius }).addTo(map)
      .bindPopup(`<b style='color: ${loc.color};'>üìç ${dayText} Gathering</b><br>${loc.name} (8:00 AM & 5:30 PM)`);
    
    updateMarkers();
}

function updateMarkers() {
    let today = new Date().toDateString();
    let activeTodayCount = 0;

    feeders.forEach(f => {
        let currentStreak = f.streak || 0; 
        let streakText = currentStreak > 0 ? ` <span style="color:#d35400; font-weight:bold;">üî• ${currentStreak}</span>` : "";
        let foodText = f.food ? `<br><span style="font-size:0.9em; color:#555;">Feeding: ${f.food}</span>` : "";
        
        if (map) {
            L.marker([f.lat, f.lng], { icon: colorfulBirdIcon }).addTo(map)
                .bindPopup(`<b style='color: #1b4332;'>üåø ${f.username}</b>${streakText}${foodText}`);
        }
        
        if (f.lastActive === today || f.lastVerified === today || (currentStreak === 0 && !f.lastVerified)) {
            activeTodayCount++;
        }
    });
    
    document.getElementById("counter").innerText = activeTodayCount;
    let offlineCount = feeders.length - activeTodayCount;
    if (offlineCount < 0) offlineCount = 0;
    document.getElementById("offlineCounter").innerText = offlineCount + 99;
    updateLeaderboard();
}

function updateLeaderboard() {
    let list = document.getElementById("leaderboard");
    list.innerHTML = ""; 
    let sortedFeeders = [...feeders].sort((a, b) => (b.streak || 0) - (a.streak || 0)).slice(0, 5);
    if (sortedFeeders.length === 0) {
        list.innerHTML = "<li style='text-align:center; color:#777;'>No active feeders yet. Be the first!</li>";
        return;
    }
    sortedFeeders.forEach((f, index) => {
        let li = document.createElement("li");
        li.className = `leaderboard-item ${index < 3 ? 'rank-'+(index+1) : ''}`;
        let rankMedal = ["ü•á", "ü•à", "ü•â"][index] || `#${index + 1}`;
        li.innerHTML = `<span>${rankMedal} ${f.username}</span> <span>üî• ${f.streak || 0} Days</span>`;
        list.appendChild(li);
    });
}

function startTimer() {
    function updateTimer() {
        let now = new Date();
        let morningStart = new Date(); morningStart.setHours(8,0,0,0);
        let morningEnd = new Date(); morningEnd.setHours(9,30,0,0);
        let eveningStart = new Date(); eveningStart.setHours(17,30,0,0);
        let eveningEnd = new Date(); eveningEnd.setHours(19,0,0,0);
        let targetTime, label = document.getElementById("meetingLabel"), timerDiv = document.getElementById("timer");
        
        if (now >= morningStart && now < morningEnd) { label.innerText = "üü¢ Morning Gathering is LIVE!"; targetTime = morningEnd; } 
        else if (now >= eveningStart && now < eveningEnd) { label.innerText = "üü¢ Evening Gathering is LIVE!"; targetTime = eveningEnd; } 
        else if (now < morningStart) { label.innerText = "‚è≥ Time Left Until Morning Gathering (8:00 AM)"; targetTime = morningStart; } 
        else if (now < eveningStart) { label.innerText = "‚è≥ Time Left Until Evening Gathering (5:30 PM)"; targetTime = eveningStart; } 
        else { targetTime = new Date(morningStart); targetTime.setDate(targetTime.getDate() + 1); label.innerText = "‚è≥ Time Left Until Tomorrow's Morning Gathering"; }
        
        let diff = targetTime - now;
        let h = Math.floor(diff / (1000*60*60)), m = Math.floor((diff % (1000*60*60)) / (1000*60)), s = Math.floor((diff % (1000*60)) / 1000);
        
        if ((now >= morningStart && now < morningEnd) || (now >= eveningStart && now < eveningEnd)) {
            timerDiv.innerHTML = `Ends in: ${h}h : ${m < 10 ? '0'+m : m}m : ${s < 10 ? '0'+s : s}s`;
            timerDiv.style.background = "linear-gradient(135deg, #e74c3c, #c0392b)";
        } else {
            timerDiv.innerHTML = `${h < 10 ? '0'+h : h}h : ${m < 10 ? '0'+m : m}m : ${s < 10 ? '0'+s : s}s`;
            timerDiv.style.background = "linear-gradient(135deg, var(--forest-light), var(--forest-dark))";
        }
    }
    updateTimer(); setInterval(updateTimer,1000);
}

function setupAIVerification() {
    document.getElementById("ai-section").style.display = "block"; 
    const fileInput = document.getElementById("photoUpload");
    const statusDiv = document.getElementById("ai-status");
    const uploadLabel = document.getElementById("uploadLabel");
    let today = new Date().toDateString();

    if(currentUserData.lastVerified === today) {
        uploadLabel.style.display = "none";
        statusDiv.innerHTML = `<span class="success">‚úÖ Verified for today! Come back tomorrow.</span>`;
        return;
    }

    fileInput.addEventListener("change", async function() {
        if(this.files.length > 0) {
            uploadLabel.style.display = "none"; 
            statusDiv.innerHTML = `<span class="scanning">ü§ñ AI is looking for birds...</span>`;
            
            let formData = new FormData();
            formData.append("image", this.files[0]);

            try {
                let response = await fetch("https://heratofficial-birdfeeder.hf.space/verify-bird", { method: "POST", body: formData });
                let result = await response.json();

                if (result.success) {
                    currentUserData.streak = (currentUserData.streak || 0) + 1;
                    currentUserData.lastVerified = today;
                    statusDiv.innerHTML = `<span class="success">‚úÖ ${result.message}</span>`;
                    updateWelcomeText(); 
                    await syncFeederData(); 
                } else {
                    uploadLabel.style.display = "inline-block"; 
                    statusDiv.innerHTML = `<span style="color:#e74c3c;">‚ùå ${result.message}</span>`;
                }
            } catch (error) {
                uploadLabel.style.display = "inline-block"; 
                statusDiv.innerHTML = `<span style="color:#e74c3c;">‚ö†Ô∏è Connection Error. Try again!</span>`;
            }
        }
    });
}

function updateWelcomeText() {
    let s = currentUserData.streak > 0 ? `<span class="streak-badge">üî• ${currentUserData.streak} Day Streak</span>` : "";
    document.getElementById("welcomeText").innerHTML = `Welcome back, ${currentUserData.username} üåø ${s}`;
}

function setupLogout() {
    let logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.style.display = "block"; 
    logoutBtn.addEventListener("click", () => {
        // We DO NOT delete the deviceId, we just delete the visual login state
        localStorage.removeItem("currentUser");
        location.reload();
    });
}

async function startApp() {
    checkTime(); 
    let today = new Date().toDateString();
    
    await fetchAllFeeders(); 
    
    let savedUsername = localStorage.getItem("currentUser");
    let overlay = document.getElementById("loginOverlay");
    let joinBtn = document.getElementById("joinBtn");
    
    // Returning User (Session exists)
    if (savedUsername) {
        // Find them by their DEVICE ID, not their name anymore!
        currentUserData = feeders.find(f => f.deviceId === myDeviceId);
        
        if (!currentUserData) {
            currentUserData = { deviceId: myDeviceId, username: savedUsername, food: "üåæ Seeds", lat: 22.4707, lng: 70.0577, streak: 0, lastVerified: null, lastActive: today };
        } else {
            currentUserData.lastActive = today; 
            currentUserData.username = savedUsername; // Just in case
        }
        
        await syncFeederData(); 
        
        updateWelcomeText(); setupLogout(); setupAIVerification(); initMap(); startTimer();
        setInterval(fetchAllFeeders, 30000); 
        return;
    }
    
    // "New" User or Logged Out User
    overlay.classList.add("active");
    joinBtn.addEventListener("click", () => {
        let username = document.getElementById("usernameInput").value.trim();
        let foodChoice = document.getElementById("foodInput").value;
        if(!username){ alert("Please enter a username!"); return; }
        
        joinBtn.disabled = true; joinBtn.innerText = "Finding your location... üìç";
        
        if(navigator.geolocation){
            navigator.geolocation.getCurrentPosition(async position => {
                
                // NEW LOGIC: This creates the profile, overwriting the old one on the server because the deviceId matches!
                currentUserData = { 
                    deviceId: myDeviceId, 
                    username: username, 
                    food: foodChoice, 
                    lat: position.coords.latitude, 
                    lng: position.coords.longitude, 
                    streak: 0, 
                    lastVerified: null, 
                    lastActive: today 
                };
                
                localStorage.setItem("currentUser", username);
                
                await syncFeederData(); // Sends the reset to Hugging Face
                
                updateWelcomeText(); setupLogout(); setupAIVerification(); overlay.classList.remove("active"); initMap(); startTimer();
                setInterval(fetchAllFeeders, 30000);
            }, () => { 
                alert("Location permission is required to put you on the map."); 
                joinBtn.disabled = false; joinBtn.innerText = "Join Community"; 
            });
        }
    });
}

startApp();
</script>
